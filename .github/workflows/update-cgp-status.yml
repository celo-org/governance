name: Update CGP Status

on:
  workflow_dispatch:
    inputs:
      cgp_number:
        description: 'CGP number (e.g., 100 for cgp-0100.md)'
        required: true
        type: number
      status:
        description: 'CGP Status'
        required: true
        type: choice
        options:
          - DRAFT
          - PROPOSED
          - EXECUTED
          - EXPIRED
          - WITHDRAWN
          - REJECTED
      onchain_id:
        description: 'On-chain governance proposal ID (not required for WITHDRAWN)'
        required: false
        type: number
      date_executed:
        description: 'Date executed (YYYY-MM-DD, only for EXECUTED status)'
        required: false
        type: string
      dry_run:
        description: 'Dry run mode - validate without making changes'
        required: false
        type: boolean
        default: false

jobs:
  update-cgp:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            **/node_modules
            .yarn/cache
          key: ${{ runner.os }}-yarn-cache-${{ hashFiles('./yarn.lock') }}

      - name: Install dependencies
        run: yarn install --immutable

      - name: Validate inputs
        run: |
          # Check that EXECUTED status has date_executed
          if [[ "${{ inputs.status }}" == "EXECUTED" ]] && [[ -z "${{ inputs.date_executed }}" ]]; then
            echo "Error: date_executed is required when status is EXECUTED"
            exit 1
          fi

          # Check date format if provided
          if [[ -n "${{ inputs.date_executed }}" ]] && [[ ! "${{ inputs.date_executed }}" =~ ^[0-9]{4}-[0-9]{2}-[0-9]{2}$ ]]; then
            echo "Error: date_executed must be in YYYY-MM-DD format"
            exit 1
          fi

          # Check that non-WITHDRAWN/DRAFT statuses have onchain_id
          if [[ "${{ inputs.status }}" != "WITHDRAWN" ]] && [[ "${{ inputs.status }}" != "DRAFT" ]] && [[ -z "${{ inputs.onchain_id }}" ]]; then
            echo "Error: onchain_id is required for ${{ inputs.status }} status"
            exit 1
          fi

      - name: Update CGP status
        env:
          RPC_URL: https://forno.celo.org
        run: |
          # Build the command with optional parameters
          cmd="node scripts/update-cgp-status.js ${{ inputs.cgp_number }} ${{ inputs.status }}"

          if [[ -n "${{ inputs.onchain_id }}" ]]; then
            cmd="$cmd ${{ inputs.onchain_id }}"
          fi

          if [[ -n "${{ inputs.date_executed }}" ]]; then
            cmd="$cmd ${{ inputs.date_executed }}"
          fi

          if [[ "${{ inputs.dry_run }}" == "true" ]]; then
            cmd="$cmd --dry-run"
          fi

          echo "Running: $cmd"
          $cmd

      - name: Validate updated CGP
        if: ${{ inputs.dry_run == false }}
        run: yarn run validate

      - name: Dry run summary
        if: ${{ inputs.dry_run == true }}
        run: |
          echo "âœ“ Dry run completed successfully!"
          echo "No changes were written to files."
          echo "All validations passed."

      - name: Create Pull Request
        if: ${{ inputs.dry_run == false }}
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            Update CGP-${{ inputs.cgp_number }} status to ${{ inputs.status }}

            - Status: ${{ inputs.status }}
            - On-chain ID: ${{ inputs.onchain_id || 'N/A' }}
            - Date Executed: ${{ inputs.date_executed || 'N/A' }}

            Validated on-chain before update.
          branch: update-cgp-${{ inputs.cgp_number }}-${{ github.run_number }}
          delete-branch: true
          title: 'Update CGP-${{ inputs.cgp_number }} status to ${{ inputs.status }}'
          body: |
            ## Summary
            Automated update of CGP-${{ inputs.cgp_number }} front matter.

            ### Changes
            - **Status**: ${{ inputs.status }}
            - **On-chain ID**: ${{ inputs.onchain_id || 'N/A' }}
            - **Date Executed**: ${{ inputs.date_executed || 'N/A' }}

            ### Validation
            This update includes on-chain validation to ensure:
            - The proposal matches the CGP number
            - The status is valid for the current on-chain state
            - EXECUTED proposals cannot be overwritten

            ### Workflow Details
            - **Triggered by**: @${{ github.actor }}
            - **Run ID**: ${{ github.run_id }}

            This PR was automatically generated by the Update CGP Status workflow.
          labels: |
            automated
            cgp-update
